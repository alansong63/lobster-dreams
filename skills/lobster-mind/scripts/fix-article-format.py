#!/usr/bin/env python3
"""
fix-article-format.py - ä¿®å¤æ–‡ç« æ ¼å¼
å°†ç®€å•çš„æ–‡ç« æ ¼å¼è½¬æ¢ä¸ºæ ‡å‡†æ¨¡æ¿
"""

import os
import re
import sys
from pathlib import Path
from datetime import datetime

REPO_DIR = Path("/home/ubuntu/.openclaw/workspace/lobster-dreams")

# æ ‡å‡†æ¨¡æ¿
TEMPLATE = '''<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <title>{title} - Lobster's Dreams</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="../styles.css">
  <style>
    :root {{ --article-width: 680px; }}
    body {{ line-height: 1.9; }}
    .container {{ max-width: var(--article-width); margin: 0 auto; padding: var(--space-3xl) var(--space-lg); }}
    header {{ text-align: left; margin-bottom: var(--space-3xl); padding-bottom: var(--space-xl); border-bottom: 1px solid var(--border); }}
    .back {{ display: inline-block; text-decoration: none; font-size: 0.85rem; color: var(--text-muted); margin-bottom: var(--space-xl); transition: color var(--transition); }}
    .back:hover {{ color: var(--accent); }}
    .post-date {{ font-family: var(--font-display); font-size: 0.9rem; color: var(--text-muted); letter-spacing: 0.05em; margin-bottom: var(--space-md); display: block; }}
    h1 {{ font-family: var(--font-display); font-size: 2.2rem; font-weight: 500; line-height: 1.2; margin-bottom: var(--space-lg); color: var(--text-primary); }}
    .topic-tag {{ display: inline-block; padding: 4px 12px; border: 1px solid var(--border-light); font-size: 0.75rem; text-transform: lowercase; letter-spacing: 0.05em; color: var(--text-secondary); }}
    .content {{ font-size: 1.1rem; }}
    .content p {{ margin-bottom: var(--space-lg); }}
    .content strong {{ font-weight: 600; }}
    .content em {{ font-style: italic; }}
    .content h2 {{ font-family: var(--font-display); font-size: 1.6rem; font-weight: 500; margin: var(--space-3xl) 0 var(--space-lg); padding-bottom: var(--space-md); border-bottom: 1px solid var(--border); color: var(--text-primary); }}
    .content h3 {{ font-family: var(--font-display); font-size: 1.25rem; font-weight: 500; margin: var(--space-xl) 0 var(--space-md); color: var(--accent); }}
    .content ul, .content ol {{ margin: var(--space-lg) 0; padding-left: var(--space-xl); }}
    .content li {{ margin: var(--space-md) 0; }}
    .content blockquote {{ border-left: 3px solid var(--accent); padding-left: var(--space-lg); margin: var(--space-xl) 0; color: var(--text-secondary); font-style: italic; }}
    footer {{ margin-top: var(--space-3xl); padding-top: var(--space-xl); border-top: 1px solid var(--border); }}
    .end-mark {{ font-size: 1.2rem; color: var(--text-muted); margin-top: var(--space-xl); }}
    .theme-toggle {{ position: fixed; top: var(--space-lg); right: var(--space-lg); width: 40px; height: 40px; border: 1px solid var(--border); border-radius: 0; background: var(--bg-secondary); cursor: pointer; font-size: 1rem; display: flex; align-items: center; justify-content: center; transition: all var(--transition); z-index: 100; }}
    .theme-toggle:hover {{ border-color: var(--accent); }}
    @media (max-width: 600px) {{
      .container {{ padding: var(--space-xl) var(--space-md); }}
      h1 {{ font-size: 1.8rem; }}
      .content h2 {{ font-size: 1.35rem; }}
      .theme-toggle {{ top: var(--space-md); right: var(--space-md); }}
    }}
  </style>
</head>
<body>
  <div class="container">
    <button class="theme-toggle" id="themeToggle" title="åˆ‡æ¢ä¸»é¢˜"><span class="theme-icon"></span></button>
    <a href="../index.html" class="back">â† è¿”å›</a>
    <header>
      <span class="post-date">{date_display}</span>
      <h1>{title}</h1>
      <span class="topic-tag">{topic}</span>
    </header>
    <div class="content">
{content}
      <p class="end-mark">ğŸ¦</p>
    </div>
    <footer><p>Generated by OpenClaw Dreaming System</p></footer>
  </div>
  <script>
    (function() {{
      const themeToggle = document.getElementById('themeToggle');
      const themeIcon = themeToggle.querySelector('.theme-icon');
      const savedTheme = localStorage.getItem('lobster-theme') || 'dark';
      document.body.classList.add(savedTheme);
      themeIcon.textContent = savedTheme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
      themeToggle.addEventListener('click', function() {{
        const currentTheme = document.body.classList.contains('dark') ? 'dark' : 'light';
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        document.body.classList.remove(currentTheme);
        document.body.classList.add(newTheme);
        localStorage.setItem('lobster-theme', newTheme);
        themeIcon.textContent = newTheme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
      }});
    }})();
  </script>
</body>
</html>'''


def extract_content(html_content: str) -> tuple:
    """æå–æ–‡ç« æ ‡é¢˜ã€æ—¥æœŸå’Œå†…å®¹"""
    
    # æå–æ ‡é¢˜
    title_match = re.search(r'<title>([^|<]+)', html_content)
    title = title_match.group(1).strip() if title_match else "æ— æ ‡é¢˜"
    
    # æå–æ—¥æœŸ
    date_match = re.search(r'(\d{4}-\d{2}-\d{2})', html_content)
    date = date_match.group(1) if date_match else datetime.now().strftime('%Y-%m-%d')
    date_display = date.replace('-', '.')
    
    # æå–åˆ†ç±»
    category_match = re.search(r'<span class="category">([^<]+)', html_content)
    topic = category_match.group(1) if category_match else "general"
    
    # æå–å†…å®¹ï¼ˆä» <section> æˆ– <article> ä¸­ï¼‰
    content = ""
    
    # å°è¯•ä» <section> æå–
    section_match = re.search(r'<section>(.*?)</section>', html_content, re.DOTALL)
    if section_match:
        content = section_match.group(1).strip()
    else:
        # å°è¯•ä» <article> æå–
        article_match = re.search(r'<article[^>]*>(.*?)</article>', html_content, re.DOTALL)
        if article_match:
            content = article_match.group(1).strip()
    
    # æ¸…ç†å†…å®¹ï¼Œç§»é™¤ section æ ‡ç­¾ä½†ä¿ç•™å†…éƒ¨å†…å®¹
    content = re.sub(r'<section[^>]*>', '', content)
    content = re.sub(r'</section>', '', content)
    content = re.sub(r'<div class="meta">.*?</div>', '', content, flags=re.DOTALL)
    content = re.sub(r'<span class="author">.*?</span>', '', content)
    
    # ç¼©è¿›æ¯ä¸€è¡Œ
    content_lines = content.split('\n')
    indented_content = '\n'.join('      ' + line.strip() for line in content_lines if line.strip())
    
    return title, date, date_display, topic, indented_content


def fix_article(file_path: Path) -> bool:
    """ä¿®å¤å•ä¸ªæ–‡ç« """
    print(f"ğŸ“ å¤„ç†: {file_path.name}")
    
    try:
        content = file_path.read_text(encoding='utf-8')
        
        # æ£€æŸ¥æ˜¯å¦å·²ç»æ˜¯æ­£ç¡®æ ¼å¼
        if '<style>' in content and 'container' in content:
            print(f"  âœ… å·²ç»æ˜¯æ­£ç¡®æ ¼å¼ï¼Œè·³è¿‡")
            return False
        
        # æå–ä¿¡æ¯
        title, date, date_display, topic, article_content = extract_content(content)
        
        # ç”Ÿæˆæ–°å†…å®¹
        new_content = TEMPLATE.format(
            title=title,
            date_display=date_display,
            topic=topic,
            content=article_content
        )
        
        # å†™å…¥
        file_path.write_text(new_content, encoding='utf-8')
        print(f"  âœ… å·²ä¿®å¤: {title[:30]}...")
        return True
        
    except Exception as e:
        print(f"  âŒ å¤±è´¥: {e}")
        return False


def main():
    print("=" * 50)
    print("ğŸ¦ Wild Dreams æ–‡ç« æ ¼å¼ä¿®å¤å·¥å…·")
    print("=" * 50)
    
    # éœ€è¦ä¿®å¤çš„æ–‡ç« åˆ—è¡¨
    articles_to_fix = [
        REPO_DIR / "dreams" / "creative-fatigue-2026-02-16.html",
        REPO_DIR / "essays" / "2026-02-16.html",
        REPO_DIR / "ideas" / "2026-02-16.html",
        REPO_DIR / "thoughts" / "2026-02-16.html",
    ]
    
    fixed_count = 0
    for article_path in articles_to_fix:
        if article_path.exists():
            if fix_article(article_path):
                fixed_count += 1
        else:
            print(f"âš ï¸ æ–‡ä»¶ä¸å­˜åœ¨: {article_path}")
    
    print(f"\nå…±ä¿®å¤ {fixed_count} ç¯‡æ–‡ç« ")
    
    # Git æäº¤
    if fixed_count > 0:
        print("\nğŸ“¦ æäº¤æ›´æ”¹...")
        import subprocess
        os.chdir(REPO_DIR)
        subprocess.run(["git", "add", "-A"], capture_output=True)
        
        msg = f"fix: ä¿®å¤æ–‡ç« æ ¼å¼æ¨¡æ¿ - {datetime.now().strftime('%Y-%m-%d %H:%M')}"
        subprocess.run(["git", "commit", "-m", msg], capture_output=True)
        subprocess.run(["git", "push", "origin", "master"], capture_output=True)
        print("  âœ… å·²æ¨é€")
    
    print("\nğŸ‰ å®Œæˆï¼")


if __name__ == "__main__":
    main()
