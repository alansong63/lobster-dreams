#!/usr/bin/env python3
"""
validate-article.py - æ–‡ç« é¢„å‘å¸ƒéªŒè¯
æ£€æŸ¥æ–‡ç« æ˜¯å¦ç¬¦åˆæ ‡å‡†
"""

import re
import sys
from pathlib import Path
from datetime import datetime

REPO_DIR = Path("/home/ubuntu/.openclaw/workspace/lobster-dreams")
SECTIONS = ["dreams", "thoughts", "ideas", "essays", "reflections", "lifestyle"]

class Validator:
    def __init__(self):
        self.errors = []
        self.warnings = []
        self.passed = 0
    
    def check(self, condition: bool, msg: str, is_error: bool = True):
        if condition:
            self.passed += 1
        else:
            if is_error:
                self.errors.append(msg)
            else:
                self.warnings.append(msg)

def validate_article(file_path: Path) -> dict:
    """éªŒè¯å•ä¸ªæ–‡ç« """
    validator = Validator()
    
    try:
        content = file_path.read_text(encoding='utf-8')
        
        # æ£€æŸ¥ 1: æ˜¯å¦æœ‰ style æ ‡ç­¾
        has_style = '<style>' in content or '<style ' in content
        validator.check(has_style, f"{file_path.name}: ç¼ºå°‘ <style> æ ‡ç­¾", is_error=False)
        
        # æ£€æŸ¥ 2: æ˜¯å¦æœ‰ container
        has_container = 'class="container"' in content
        validator.check(has_container, f"{file_path.name}: ç¼ºå°‘ container", is_error=False)
        
        # æ£€æŸ¥ 3: æ˜¯å¦æœ‰è¿”å›é“¾æ¥
        has_back = 'class="back"' in content or 'href="../index.html"' in content
        validator.check(has_back, f"{file_path.name}: ç¼ºå°‘è¿”å›é“¾æ¥", is_error=False)
        
        # æ£€æŸ¥ 4: æ˜¯å¦æœ‰ footer
        has_footer = '<footer>' in content or 'Generated by' in content
        validator.check(has_footer, f"{file_path.name}: ç¼ºå°‘ footer", is_error=False)
        
        # æ£€æŸ¥ 5: æ—¥æœŸæ ¼å¼
        date_match = re.search(r'(\d{4}[-.\}]\d{2}[-.\}]\d{2})', content)
        if date_match:
            validator.check(True, "")
        else:
            validator.errors.append(f"{file_path.name}: ç¼ºå°‘æ—¥æœŸ")
        
        # æ£€æŸ¥ 6: æ ‡é¢˜
        title_match = re.search(r'<title>([^|<]+)', content)
        if title_match:
            validator.check(True, "")
        else:
            validator.errors.append(f"{file_path.name}: ç¼ºå°‘æ ‡é¢˜")
        
        # æ£€æŸ¥ 7: å†…å®¹é•¿åº¦
        content_length = len(content)
        if content_length < 1000:
            validator.warnings.append(f"{file_path.name}: å†…å®¹è¿‡çŸ­ ({content_length} chars)")
        
        return {
            "file": file_path.name,
            "valid": len(validator.errors) == 0,
            "errors": validator.errors,
            "warnings": validator.warnings,
            "passed": validator.passed
        }
    
    except Exception as e:
        return {
            "file": file_path.name,
            "valid": False,
            "errors": [f"è¯»å–å¤±è´¥: {e}"],
            "warnings": [],
            "passed": 0
        }

def validate_index() -> dict:
    """éªŒè¯ index.html"""
    validator = Validator()
    index_file = REPO_DIR / "index.html"
    
    if not index_file.exists():
        return {"valid": False, "errors": ["index.html ä¸å­˜åœ¨"]}
    
    content = index_file.read_text(encoding='utf-8')
    
    # æ£€æŸ¥æ–‡ç« æ•°é‡
    post_cards = content.count('class="post-card"')
    validator.check(post_cards > 0, "index ç¼ºå°‘æ–‡ç« å¡ç‰‡")
    
    # æ£€æŸ¥ç»Ÿè®¡æ•°å­—
    total_match = re.search(r'id="totalCount">(\d+)<', content)
    if total_match:
        count = int(total_match.group(1))
        # å…è®¸ä¸€å®šçš„è¯¯å·®
        if count < post_cards - 2 or count > post_cards + 2:
            validator.warnings.append(f"ç»Ÿè®¡æ•°å­— ({count}) ä¸å®é™…æ–‡ç« æ•° ({post_cards}) ä¸ç¬¦")
    
    return {
        "valid": len(validator.errors) == 0,
        "errors": validator.errors,
        "warnings": validator.warnings
    }

def main():
    print("=" * 60)
    print("ğŸ” Wild Dreams æ–‡ç« é¢„å‘å¸ƒéªŒè¯")
    print("=" * 60)
    
    total_errors = 0
    total_warnings = 0
    
    # éªŒè¯å„æ¿å—æ–‡ç« 
    print("\nğŸ“„ éªŒè¯æ–‡ç« ...")
    for section in SECTIONS:
        section_dir = REPO_DIR / section
        if not section_dir.exists():
            continue
        
        html_files = list(section_dir.glob("*.html"))
        html_files = [f for f in html_files if f.name != "index.html"]
        
        if not html_files:
            continue
        
        print(f"\n  ğŸ“‚ {section}: {len(html_files)} ç¯‡")
        
        for html_file in html_files:
            result = validate_article(html_file)
            
            if result["valid"]:
                print(f"    âœ… {result['file']}")
            else:
                print(f"    âŒ {result['file']}")
                for err in result["errors"]:
                    print(f"       - {err}")
                    total_errors += 1
            
            for warn in result["warnings"]:
                print(f"    âš ï¸ {warn}")
                total_warnings += 1
    
    # éªŒè¯ index
    print("\nğŸ“‹ éªŒè¯ index...")
    index_result = validate_index()
    
    if index_result["valid"]:
        print("    âœ… index.html")
    else:
        print("    âŒ index.html")
        for err in index_result["errors"]:
            print(f"       - {err}")
            total_errors += 1
    
    for warn in index_result["warnings"]:
        print(f"    âš ï¸ {warn}")
        total_warnings += 1
    
    # æ€»ç»“
    print("\n" + "=" * 60)
    if total_errors == 0 and total_warnings == 0:
        print("ğŸ‰ å…¨éƒ¨éªŒè¯é€šè¿‡ï¼")
    elif total_errors == 0:
        print(f"âš ï¸ éªŒè¯é€šè¿‡ï¼Œä½†æœ‰ {total_warnings} ä¸ªè­¦å‘Š")
    else:
        print(f"âŒ éªŒè¯å¤±è´¥: {total_errors} ä¸ªé”™è¯¯, {total_warnings} ä¸ªè­¦å‘Š")
    print("=" * 60)
    
    # è¿”å›çŠ¶æ€ç 
    sys.exit(0 if total_errors == 0 else 1)

if __name__ == "__main__":
    main()
